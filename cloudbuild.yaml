steps:
  # ==========================================
  # Step 1: Wait logic for running triggers
  # ==========================================
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: bash
    args:
      - -c
      - |
        echo "‚è≥ Checking current trigger against actively running triggers..."

        WATCHED_TRIGGERS=("trigger-1" "trigger-3")
        CURRENT_TRIGGER="$${_TRIGGER_NAME:-trigger-2}"
        echo "‚ÑπÔ∏è Current Trigger: $$CURRENT_TRIGGER"

        # Get CURRENT build info - ONLY if it's still running or queued
        CURRENT_BUILD_INFO=$$(gcloud builds list --region=asia-east1 \
          --filter="status:(WORKING OR QUEUED) AND substitutions.TRIGGER_NAME=$$CURRENT_TRIGGER" \
          --sort-by="~createTime" --limit=1 \
          --format="value(id,createTime)")
        
        if [[ -z "$$CURRENT_BUILD_INFO" ]]; then
          echo "‚ö†Ô∏è No ongoing build found for $$CURRENT_TRIGGER (maybe already finished)."
          exit 0
        fi

        CURRENT_BUILD_ID=$$(echo "$$CURRENT_BUILD_INFO" | awk '{print $$1}')
        CURRENT_START_TIME=$$(echo "$$CURRENT_BUILD_INFO" | awk '{print $$2}')
        echo "‚è∞ Current build $$CURRENT_BUILD_ID started at: $$CURRENT_START_TIME"

        # Check if this is earliest ongoing trigger
        SKIP_WAIT="true"
        for TRIGGER in "$${WATCHED_TRIGGERS[@]}"; do
          if [[ "$$TRIGGER" == "$$CURRENT_TRIGGER" ]]; then
            continue
          fi
          LATEST_BUILD=$$(gcloud builds list --region=asia-east1 \
            --filter="status:(WORKING OR QUEUED) AND substitutions.TRIGGER_NAME=$$TRIGGER" \
            --sort-by="~createTime" --limit=1 \
            --format="value(id,createTime)")
          if [[ -n "$$LATEST_BUILD" ]]; then
            OTHER_START=$$(echo "$$LATEST_BUILD" | awk '{print $$2}')
            if [[ "$$OTHER_START" < "$$CURRENT_START_TIME" ]]; then
              SKIP_WAIT="false"
              echo "‚è≥ $$TRIGGER is still running and started earlier at $$OTHER_START"
              break
            fi
          fi
        done

        if [[ "$$SKIP_WAIT" == "true" ]]; then
          echo "‚úÖ No earlier running triggers found ‚Üí skipping wait logic."
          exit 0
        fi

        echo "‚ö†Ô∏è Found earlier running trigger(s) ‚Üí waiting for them to finish..."

        wait_for_build() {
          local TRIGGER_NAME=$$1
          local BUILD_ID=$$2
          while true; do
            STATUS=$$(gcloud builds describe $$BUILD_ID --region=asia-east1 --format="value(status)")
            if [[ "$$STATUS" == "SUCCESS" || "$$STATUS" == "FAILURE" || "$$STATUS" == "CANCELLED" ]]; then
              echo "üîπ $$TRIGGER_NAME build $$BUILD_ID finished with $$STATUS"
              break
            fi
            echo "‚è± $$TRIGGER_NAME build $$BUILD_ID still running, waiting 15s..."
            sleep 15
          done
          if [[ "$$STATUS" == "SUCCESS" ]]; then
            echo "‚úÖ $$TRIGGER_NAME succeeded. Waiting 90 seconds..."
            sleep 90
          else
            echo "‚ö†Ô∏è $$TRIGGER_NAME failed/cancelled. Waiting 30 seconds..."
            sleep 30
          fi
        }

        # Wait for all earlier *running* triggers
        for TRIGGER in "$${WATCHED_TRIGGERS[@]}"; do
          if [[ "$$TRIGGER" == "$$CURRENT_TRIGGER" ]]; then
            continue
          fi
          BUILD_INFO=$$(gcloud builds list --region=asia-east1 \
            --filter="status:(WORKING OR QUEUED) AND substitutions.TRIGGER_NAME=$$TRIGGER" \
            --sort-by="~createTime" --limit=1 \
            --format="value(id,createTime)")
          if [[ -z "$$BUILD_INFO" ]]; then
            echo "‚ÑπÔ∏è No running build found for $$TRIGGER, skipping."
            continue
          fi
          BUILD_ID=$$(echo "$$BUILD_INFO" | awk '{print $$1}')
          BUILD_START=$$(echo "$$BUILD_INFO" | awk '{print $$2}')

          if [[ "$$BUILD_START" < "$$CURRENT_START_TIME" ]]; then
            wait_for_build "$$TRIGGER" "$$BUILD_ID"
          fi
        done


  # ==========================================
  # Step 2: Generate version tag
  # ==========================================
  - name: gcr.io/cloud-builders/gcloud
    id: generate-version
    entrypoint: bash
    args:
      - -c
      - |
        VERSION_TAG="v-$(date +%Y%m%d-%H%M%S)"
        echo "VERSION_TAG=$$VERSION_TAG" > /workspace/version.env
        echo "Generated version: $$VERSION_TAG"

  # ==========================================
  # Step 3: Clone GitHub repo & unzip
  # ==========================================
  - name: gcr.io/cloud-builders/git
    id: clone-repo
    args:
      - clone
      - https://github.com/${_GITHUB_REPO}.git
      - /workspace/app

  # ==========================================
  # Step 4: Write startup script to run Flask app
  # ==========================================
  - name: gcr.io/cloud-builders/gcloud
    id: write-startup-script
    entrypoint: bash
    args:
      - -c
      - |
        echo "[SCRIPT] Writing startup script..."
        cat << 'EOF' > startup-script.sh
        #!/bin/bash
        set -e

        echo "Installing Python and dependencies..."
        sudo apt-get update -y
        sudo apt-get install -y python3 python3-pip unzip

        cd /home/ubuntu
        mkdir -p flask-app
        cp /workspace/app/* flask-app/

        echo "Installing Flask..."
        pip3 install flask

        echo "Starting Flask app..."
        nohup python3 flask-app/app.py > flask.log 2>&1 &
        EOF

  # ==========================================
  # Step 5: Create image from MIG VM
  # ==========================================
  - name: gcr.io/cloud-builders/gcloud
    id: create-image
    entrypoint: bash
    args:
      - -c
      - |
        source /workspace/version.env
        echo "[MIG] Fetching MIG instance boot disk..."
        VM_NAME=$(gcloud compute instance-groups managed list-instances ${_MIG_NAME} --zone ${_ZONE} --format="value(instance.basename())" | head -n 1)
        BOOT_DISK=$(gcloud compute instances describe $$VM_NAME --zone=${_ZONE} --format="value(disks[0].source.basename())")

        echo "[IMAGE] Creating image from boot disk $$BOOT_DISK"
        gcloud compute images create backend-image-$$VERSION_TAG \
          --source-disk=$$BOOT_DISK \
          --source-disk-zone=${_ZONE} \
          --family=backend-family \
          --project=crested-polygon-472204-n5 \
          --force

  # ==========================================
  # Step 6: Create instance template
  # ==========================================
  - name: gcr.io/cloud-builders/gcloud
    id: create-template
    entrypoint: bash
    args:
      - -c
      - |
        source /workspace/version.env
        echo "[GCE] Creating instance template..."
        gcloud compute instance-templates create backend-template-$$VERSION_TAG \
          --project=crested-polygon-472204-n5 \
          --machine-type=n2-standard-2 \
          --image=backend-image-$$VERSION_TAG \
          --image-project=crested-polygon-472204-n5 \
          --service-account=613125347481-compute@developer.gserviceaccount.com \
          --scopes=https://www.googleapis.com/auth/cloud-platform \
          --metadata-from-file=startup-script=startup-script.sh \
          --network=default \
          --subnet=default\
          --tags=http-server,https-server,lb-health-check \
          --region=asia-east1

  # ==========================================
  # Step 7: Rolling update MIG + delete old VMs
  # ==========================================
  - name: gcr.io/cloud-builders/gcloud
    id: update-mig
    entrypoint: bash
    args:
      - -c
      - |
        source /workspace/version.env
        echo "[MIG] Performing rolling update..."
        gcloud compute instance-groups managed rolling-action start-update \
          ${_MIG_NAME} \
          --zone=${_ZONE} \
          --version "template=backend-template-$$VERSION_TAG" \
          --minimal-action=replace \
          --max-surge=1 \
          --max-unavailable=1
        echo "[WAIT] Sleeping for 60 seconds before cleanup to let new VMs stabilize..."
        sleep 60
        echo "[CLEANUP] Deleting old instances (force)..."
        OLD_INSTANCES=$(gcloud compute instance-groups managed list-instances ${_MIG_NAME} --zone=${_ZONE} --format="value(instance.basename())")
        for VM in $$OLD_INSTANCES; do
          gcloud compute instances delete $$VM --zone=${_ZONE} --quiet --delete-disks=all || true
        done

options:
  logging: CLOUD_LOGGING_ONLY
substitutions:
  _TRIGGER_NAME: "trigger-2"
  _MIG_NAME: "vamsi-mig"
  _ZONE: "asia-east1-b"
  _GITHUB_REPO: "20481A04K2/repo2"
